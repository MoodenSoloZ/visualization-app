"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _fs = _interopRequireDefault(require("fs"));

var _es6Promisify = require("es6-promisify");

var fsOpen = _fs.default && (0, _es6Promisify.promisify)(_fs.default.open);
var fsRead = _fs.default && (0, _es6Promisify.promisify)(_fs.default.read);
var fsFStat = _fs.default && (0, _es6Promisify.promisify)(_fs.default.fstat);
var fsReadFile = _fs.default && (0, _es6Promisify.promisify)(_fs.default.readFile);
var fsClose = _fs.default && (0, _es6Promisify.promisify)(_fs.default.close);

var LocalFile = /*#__PURE__*/function () {
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  function LocalFile(source) {
    var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    (0, _classCallCheck2.default)(this, LocalFile);
    (0, _defineProperty2.default)(this, "fd", void 0);
    (0, _defineProperty2.default)(this, "filename", void 0);
    this.filename = source;
  }

  (0, _createClass2.default)(LocalFile, [{
    key: "getFd",
    value: function getFd() {
      if (!this.fd) {
        this.fd = fsOpen(this.filename, 'r');
      }

      return this.fd;
    }
  }, {
    key: "read",
    value: function () {
      var _read = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(buffer) {
        var offset,
            length,
            position,
            fetchLength,
            ret,
            _args = arguments;
        return _regenerator.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                offset = _args.length > 1 && _args[1] !== undefined ? _args[1] : 0;
                length = _args.length > 2 ? _args[2] : undefined;
                position = _args.length > 3 && _args[3] !== undefined ? _args[3] : 0;
                fetchLength = Math.min(buffer.length - offset, length);
                _context.t0 = fsRead;
                _context.next = 7;
                return this.getFd();

              case 7:
                _context.t1 = _context.sent;
                _context.t2 = buffer;
                _context.t3 = offset;
                _context.t4 = fetchLength;
                _context.t5 = position;
                _context.next = 14;
                return (0, _context.t0)(_context.t1, _context.t2, _context.t3, _context.t4, _context.t5);

              case 14:
                ret = _context.sent;
                return _context.abrupt("return", {
                  bytesRead: ret,
                  buffer: buffer
                });

              case 16:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function read(_x) {
        return _read.apply(this, arguments);
      }

      return read;
    }()
  }, {
    key: "readFile",
    value: function () {
      var _readFile = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2(options) {
        return _regenerator.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                return _context2.abrupt("return", fsReadFile(this.filename, options));

              case 1:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function readFile(_x2) {
        return _readFile.apply(this, arguments);
      }

      return readFile;
    }() // todo memoize

  }, {
    key: "stat",
    value: function () {
      var _stat = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3() {
        return _regenerator.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.t0 = fsFStat;
                _context3.next = 3;
                return this.getFd();

              case 3:
                _context3.t1 = _context3.sent;
                return _context3.abrupt("return", (0, _context3.t0)(_context3.t1));

              case 5:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function stat() {
        return _stat.apply(this, arguments);
      }

      return stat;
    }()
  }, {
    key: "close",
    value: function () {
      var _close = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee4() {
        return _regenerator.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.t0 = fsClose;
                _context4.next = 3;
                return this.getFd();

              case 3:
                _context4.t1 = _context4.sent;
                return _context4.abrupt("return", (0, _context4.t0)(_context4.t1));

              case 5:
              case "end":
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      function close() {
        return _close.apply(this, arguments);
      }

      return close;
    }()
  }]);
  return LocalFile;
}();

exports.default = LocalFile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sb2NhbEZpbGUudHMiXSwibmFtZXMiOlsiZnNPcGVuIiwiZnMiLCJvcGVuIiwiZnNSZWFkIiwicmVhZCIsImZzRlN0YXQiLCJmc3RhdCIsImZzUmVhZEZpbGUiLCJyZWFkRmlsZSIsImZzQ2xvc2UiLCJjbG9zZSIsIkxvY2FsRmlsZSIsInNvdXJjZSIsIm9wdHMiLCJmaWxlbmFtZSIsImZkIiwiYnVmZmVyIiwib2Zmc2V0IiwibGVuZ3RoIiwicG9zaXRpb24iLCJmZXRjaExlbmd0aCIsIk1hdGgiLCJtaW4iLCJnZXRGZCIsInJldCIsImJ5dGVzUmVhZCIsIm9wdGlvbnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxJQUFNQSxNQUFNLEdBQUdDLGVBQU0sNkJBQVVBLFlBQUdDLElBQWIsQ0FBckI7QUFDQSxJQUFNQyxNQUFNLEdBQUdGLGVBQU0sNkJBQVVBLFlBQUdHLElBQWIsQ0FBckI7QUFDQSxJQUFNQyxPQUFPLEdBQUdKLGVBQU0sNkJBQVVBLFlBQUdLLEtBQWIsQ0FBdEI7QUFDQSxJQUFNQyxVQUFVLEdBQUdOLGVBQU0sNkJBQVVBLFlBQUdPLFFBQWIsQ0FBekI7QUFDQSxJQUFNQyxPQUFPLEdBQUdSLGVBQU0sNkJBQVVBLFlBQUdTLEtBQWIsQ0FBdEI7O0lBRXFCQyxTO0FBSW5CO0FBQ0EscUJBQW1CQyxNQUFuQixFQUFpRTtBQUFBLFFBQTlCQyxJQUE4Qix1RUFBSixFQUFJO0FBQUE7QUFBQTtBQUFBO0FBQy9ELFNBQUtDLFFBQUwsR0FBZ0JGLE1BQWhCO0FBQ0Q7Ozs7NEJBRW9CO0FBQ25CLFVBQUksQ0FBQyxLQUFLRyxFQUFWLEVBQWM7QUFDWixhQUFLQSxFQUFMLEdBQVVmLE1BQU0sQ0FBQyxLQUFLYyxRQUFOLEVBQWdCLEdBQWhCLENBQWhCO0FBQ0Q7O0FBQ0QsYUFBTyxLQUFLQyxFQUFaO0FBQ0Q7Ozs7MkdBR0NDLE07Ozs7Ozs7Ozs7O0FBQ0FDLGdCQUFBQSxNLDJEQUFTLEM7QUFDVEMsZ0JBQUFBLE07QUFDQUMsZ0JBQUFBLFEsMkRBQVcsQztBQUVMQyxnQkFBQUEsVyxHQUFjQyxJQUFJLENBQUNDLEdBQUwsQ0FBU04sTUFBTSxDQUFDRSxNQUFQLEdBQWdCRCxNQUF6QixFQUFpQ0MsTUFBakMsQzs4QkFDRmYsTTs7dUJBQWEsS0FBS29CLEtBQUwsRTs7Ozs4QkFBY1AsTTs4QkFBUUMsTTs4QkFBUUcsVzs4QkFBYUQsUTs7Ozs7QUFBcEVLLGdCQUFBQSxHO2lEQUNDO0FBQUVDLGtCQUFBQSxTQUFTLEVBQUVELEdBQWI7QUFBa0JSLGtCQUFBQSxNQUFNLEVBQU5BO0FBQWxCLGlCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O2dIQUdhVSxPOzs7OztrREFDYm5CLFVBQVUsQ0FBQyxLQUFLTyxRQUFOLEVBQWdCWSxPQUFoQixDOzs7Ozs7Ozs7Ozs7Ozs7UUFFbkI7Ozs7Ozs7Ozs7K0JBRVNyQixPOzt1QkFBYyxLQUFLa0IsS0FBTCxFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OytCQUlkZCxPOzt1QkFBYyxLQUFLYyxLQUFMLEUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBwcm9taXNpZnkgfSBmcm9tICdlczYtcHJvbWlzaWZ5J1xuaW1wb3J0IHsgR2VuZXJpY0ZpbGVoYW5kbGUsIEZpbGVoYW5kbGVPcHRpb25zIH0gZnJvbSAnLi9maWxlaGFuZGxlJ1xuXG5jb25zdCBmc09wZW4gPSBmcyAmJiBwcm9taXNpZnkoZnMub3BlbilcbmNvbnN0IGZzUmVhZCA9IGZzICYmIHByb21pc2lmeShmcy5yZWFkKVxuY29uc3QgZnNGU3RhdCA9IGZzICYmIHByb21pc2lmeShmcy5mc3RhdClcbmNvbnN0IGZzUmVhZEZpbGUgPSBmcyAmJiBwcm9taXNpZnkoZnMucmVhZEZpbGUpXG5jb25zdCBmc0Nsb3NlID0gZnMgJiYgcHJvbWlzaWZ5KGZzLmNsb3NlKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMb2NhbEZpbGUgaW1wbGVtZW50cyBHZW5lcmljRmlsZWhhbmRsZSB7XG4gIHByaXZhdGUgZmQ/OiBhbnlcbiAgcHJpdmF0ZSBmaWxlbmFtZTogc3RyaW5nXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFyc1xuICBwdWJsaWMgY29uc3RydWN0b3Ioc291cmNlOiBzdHJpbmcsIG9wdHM6IEZpbGVoYW5kbGVPcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmZpbGVuYW1lID0gc291cmNlXG4gIH1cblxuICBwcml2YXRlIGdldEZkKCk6IGFueSB7XG4gICAgaWYgKCF0aGlzLmZkKSB7XG4gICAgICB0aGlzLmZkID0gZnNPcGVuKHRoaXMuZmlsZW5hbWUsICdyJylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZmRcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkKFxuICAgIGJ1ZmZlcjogQnVmZmVyLFxuICAgIG9mZnNldCA9IDAsXG4gICAgbGVuZ3RoOiBudW1iZXIsXG4gICAgcG9zaXRpb24gPSAwLFxuICApOiBQcm9taXNlPHsgYnl0ZXNSZWFkOiBudW1iZXI7IGJ1ZmZlcjogQnVmZmVyIH0+IHtcbiAgICBjb25zdCBmZXRjaExlbmd0aCA9IE1hdGgubWluKGJ1ZmZlci5sZW5ndGggLSBvZmZzZXQsIGxlbmd0aClcbiAgICBjb25zdCByZXQgPSBhd2FpdCBmc1JlYWQoYXdhaXQgdGhpcy5nZXRGZCgpLCBidWZmZXIsIG9mZnNldCwgZmV0Y2hMZW5ndGgsIHBvc2l0aW9uKVxuICAgIHJldHVybiB7IGJ5dGVzUmVhZDogcmV0LCBidWZmZXIgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWRGaWxlKG9wdGlvbnM/OiBGaWxlaGFuZGxlT3B0aW9ucyB8IHN0cmluZyk6IFByb21pc2U8QnVmZmVyIHwgc3RyaW5nPiB7XG4gICAgcmV0dXJuIGZzUmVhZEZpbGUodGhpcy5maWxlbmFtZSwgb3B0aW9ucylcbiAgfVxuICAvLyB0b2RvIG1lbW9pemVcbiAgcHVibGljIGFzeW5jIHN0YXQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gZnNGU3RhdChhd2FpdCB0aGlzLmdldEZkKCkpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIGZzQ2xvc2UoYXdhaXQgdGhpcy5nZXRGZCgpKVxuICB9XG59XG4iXX0=